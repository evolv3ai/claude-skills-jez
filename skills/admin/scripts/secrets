#!/bin/bash
# =============================================================================
# Admin Vault - age-encrypted secrets management
# =============================================================================
# Adapted from josh-stephens/secrets-management for admin suite architecture.
# Uses satellite ~/.admin/.env to locate vault at $ADMIN_ROOT/vault.age.
#
# Usage:
#   secrets KEY                    - Get single secret value
#   secrets -l, --list             - List all secret keys
#   secrets -e, --export           - Export all secrets (KEY=value format)
#   secrets -s, --source           - Source all secrets (eval $(secrets -s))
#   secrets --encrypt FILE         - Encrypt a plaintext file to vault
#   secrets --decrypt              - Decrypt and display all secrets
#   secrets --edit                 - Decrypt to temp, edit, re-encrypt
#   secrets --status               - Show vault status and paths
#   secrets -h, --help             - Show this help
#
# Files:
#   Key:       ~/.age/key.txt (never commit/sync this)
#   Vault:     $ADMIN_ROOT/vault.age (encrypted, git-safe)
#   Satellite: ~/.admin/.env (points to ADMIN_ROOT)
# =============================================================================

set -euo pipefail

# --- Resolve paths from satellite .env ---
SATELLITE_ENV="${HOME}/.admin/.env"

resolve_admin_root() {
    if [[ -n "${ADMIN_ROOT:-}" ]]; then
        echo "$ADMIN_ROOT"; return
    fi
    if [[ -f "$SATELLITE_ENV" ]]; then
        local root
        root=$(grep "^ADMIN_ROOT=" "$SATELLITE_ENV" 2>/dev/null | head -1 | cut -d'=' -f2-)
        if [[ -n "$root" ]]; then
            echo "$root"; return
        fi
    fi
    echo "${HOME}/.admin"
}

resolve_age_key() {
    if [[ -n "${AGE_KEY_PATH:-}" ]]; then
        echo "$AGE_KEY_PATH"; return
    fi
    if [[ -f "$SATELLITE_ENV" ]]; then
        local key_path
        key_path=$(grep "^AGE_KEY_PATH=" "$SATELLITE_ENV" 2>/dev/null | head -1 | cut -d'=' -f2-)
        if [[ -n "$key_path" ]]; then
            echo "$key_path"; return
        fi
    fi
    echo "${HOME}/.age/key.txt"
}

ADMIN_ROOT="$(resolve_admin_root)"
AGE_KEY="$(resolve_age_key)"
VAULT_FILE="${ADMIN_ROOT}/vault.age"

# --- Validation ---
check_key() {
    if [[ ! -f "$AGE_KEY" ]]; then
        echo "Error: Age key not found at $AGE_KEY" >&2
        echo "Generate one with: age-keygen -o ~/.age/key.txt" >&2
        exit 1
    fi
}

check_vault() {
    if [[ ! -f "$VAULT_FILE" ]]; then
        echo "Error: Vault not found at $VAULT_FILE" >&2
        echo "Create one with: secrets --encrypt /path/to/plaintext.env" >&2
        echo "Or migrate existing: migrate-to-vault.sh" >&2
        exit 1
    fi
}

# --- Core operations ---
decrypt_vault() {
    check_key
    check_vault
    age -d -i "$AGE_KEY" "$VAULT_FILE" 2>/dev/null
}

get_secret() {
    local key="$1"
    local value
    value=$(decrypt_vault | grep "^${key}=" | cut -d'=' -f2- | head -1 || true)
    if [[ -z "$value" ]]; then
        echo "Error: Secret '$key' not found in vault" >&2
        return 1
    fi
    echo "$value"
}

list_secrets() {
    decrypt_vault | grep -v '^#' | grep -v '^[[:space:]]*$' | cut -d'=' -f1 | sort
}

export_secrets() {
    decrypt_vault | grep -v '^#' | grep -v '^[[:space:]]*$' | grep '='
}

encrypt_file() {
    local input_file="$1"
    local output_file="${2:-$VAULT_FILE}"

    if [[ ! -f "$input_file" ]]; then
        echo "Error: File not found: $input_file" >&2
        exit 1
    fi

    check_key

    local public_key
    public_key=$(age-keygen -y "$AGE_KEY")

    age -e -r "$public_key" -a -o "$output_file" "$input_file"
    chmod 600 "$output_file"

    local count
    count=$(grep -c '=' "$input_file" 2>/dev/null || echo 0)
    echo "Encrypted: $input_file -> $output_file ($count secrets)"
}

edit_vault() {
    check_key
    check_vault

    local tmp
    tmp=$(mktemp /tmp/vault-edit.XXXXXX)
    trap 'rm -f "$tmp"' EXIT

    # Decrypt to temp file
    age -d -i "$AGE_KEY" "$VAULT_FILE" > "$tmp"

    # Open in editor
    "${EDITOR:-vi}" "$tmp"

    # Re-encrypt
    local public_key
    public_key=$(age-keygen -y "$AGE_KEY")
    age -e -r "$public_key" -a -o "$VAULT_FILE" "$tmp"

    # Secure delete temp
    rm -f "$tmp"
    trap - EXIT

    echo "Vault updated."
}

show_status() {
    echo "Admin Vault Status"
    echo "────────────────────────────────────"
    echo "Age key:     $AGE_KEY"
    if [[ -f "$AGE_KEY" ]]; then
        echo "  Status:    OK ($(stat -c '%A' "$AGE_KEY" 2>/dev/null || stat -f '%Sp' "$AGE_KEY" 2>/dev/null))"
        echo "  Public:    $(age-keygen -y "$AGE_KEY" 2>/dev/null)"
    else
        echo "  Status:    MISSING"
    fi
    echo ""
    echo "Vault:       $VAULT_FILE"
    if [[ -f "$VAULT_FILE" ]]; then
        echo "  Status:    OK ($(stat -c '%s' "$VAULT_FILE" 2>/dev/null || stat -f '%z' "$VAULT_FILE" 2>/dev/null) bytes)"
        local count
        count=$(decrypt_vault 2>/dev/null | grep -c '=' || echo "?")
        echo "  Secrets:   $count"
    else
        echo "  Status:    NOT CREATED"
    fi
    echo ""
    echo "Satellite:   $SATELLITE_ENV"
    if [[ -f "$SATELLITE_ENV" ]]; then
        echo "  ADMIN_ROOT=$ADMIN_ROOT"
        local vault_flag
        vault_flag=$(grep "^ADMIN_VAULT=" "$SATELLITE_ENV" 2>/dev/null | head -1 | cut -d'=' -f2- || echo "not set")
        echo "  ADMIN_VAULT=${vault_flag:-not set}"
    else
        echo "  Status:    MISSING"
    fi
}

# --- Main command handler ---
case "${1:-}" in
    -l|--list)
        list_secrets
        ;;
    -e|--export)
        export_secrets
        ;;
    -s|--source)
        export_secrets | while IFS= read -r line; do
            echo "export $line"
        done
        ;;
    --decrypt)
        decrypt_vault
        ;;
    --encrypt)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: secrets --encrypt FILE [OUTPUT]" >&2
            echo "  FILE:   Plaintext .env file to encrypt" >&2
            echo "  OUTPUT: Output path (default: $VAULT_FILE)" >&2
            exit 1
        fi
        encrypt_file "$2" "${3:-$VAULT_FILE}"
        ;;
    --edit)
        edit_vault
        ;;
    --status)
        show_status
        ;;
    -h|--help)
        echo "Admin Vault - age-encrypted secrets management"
        echo ""
        echo "Usage:"
        echo "  secrets KEY                    - Get value for KEY"
        echo "  secrets -l, --list             - List all secret keys"
        echo "  secrets -e, --export           - Export all secrets (KEY=value format)"
        echo "  secrets -s, --source           - Output for sourcing (eval \$(secrets -s))"
        echo "  secrets --decrypt              - Decrypt and display all secrets"
        echo "  secrets --encrypt FILE [OUT]   - Encrypt plaintext file to vault"
        echo "  secrets --edit                 - Edit vault in \$EDITOR"
        echo "  secrets --status               - Show vault status and paths"
        echo "  secrets -h, --help             - Show this help"
        echo ""
        echo "Examples:"
        echo "  secrets HCLOUD_TOKEN           - Get Hetzner API token"
        echo "  HCLOUD_TOKEN=\$(secrets HCLOUD_TOKEN)"
        echo "  eval \$(secrets -s)             - Load all secrets as env vars"
        echo ""
        echo "Files:"
        echo "  Key:       $AGE_KEY"
        echo "  Vault:     $VAULT_FILE"
        echo "  Satellite: $SATELLITE_ENV"
        ;;
    "")
        echo "Usage: secrets KEY | -l | -e | -s | --decrypt | --encrypt FILE | --edit | --status | -h" >&2
        exit 1
        ;;
    -*)
        echo "Error: Unknown option '$1'" >&2
        echo "Run 'secrets --help' for usage" >&2
        exit 1
        ;;
    *)
        get_secret "$1"
        ;;
esac
